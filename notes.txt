<?php require_once("includes/session.php"); ?>
<?php require_once("includes/db_connection.php"); ?>
<?php require_once("includes/functions.php"); ?>
<?php
$username = "";

if (isset($_POST['submit_login'])) {
  // Process the form
  
  // validations
  $required_fields = array("username", "password");
  validate_presences($required_fields);
  
  if (empty($errors)) {
    // Attempt Login

    $username = $_POST["username"];
    $password = $_POST["password"];
    
    $found_user = attempt_login($username, $password);

    if ($found_user) {
      // Success
      // Mark user as logged in
      $_SESSION["username"] = $found_user["username"];
      redirect_to("index.php");
    } else {
      // Failure
      $_SESSION["message"] = "Username/password not found.";
    }
  }
} else {
  
  
} // end: if (isset($_POST['submit']))

?>


<?php
  session_start(); // Starting Session
  $error=''; // Variable To Store Error Message
  //If login submit button is clicked
  if (isset($_POST['submit_login'])) {
    if (empty($_POST['username']) || empty($_POST['password'])) {
      $error = "Username or Password is invalid";
    } else {
      // Define $username and $password
      $username=$_POST['username'];
      $password=$_POST['password'];
      // Establishing Connection with Server by passing server_name, user_id and password as a parameter
      $connection = mysqli_connect("localhost", "root", "root", "spiralcomicsdb");
      // To protect MySQL injection for Security purpose
      $username = stripslashes($username);
      $password = stripslashes($password);
      $username = mysqli_real_escape_string($connection, $username);
      $password = mysqli_real_escape_string($connection, $password);


      // SQL query to find user match.
      $query  = "SELECT * ";
      $query .= "FROM tbl_users ";
      $query .= "WHERE username = '{$username}' ";
      $query .= "LIMIT 1";
      $user_set = mysqli_query($connection, $query);
      if($user = mysqli_fetch_assoc($user_set)) {
        return $user;
      } else {
        return null;
      }
      if ($user) {
        // found user, now check password
        if ($password = $user["password"]) {
          // password matches
          $_SESSION['username']=$username; // Initializing Session
          redirect_to("index.php"); // Refresh Home Page
          return $user;
        } else {
          // password does not match
          return false;
        }
      } else {
        // user not found
        return false;
      }
      mysqli_close($connection); // Closing Connection
    }
  }// end: if (isset($_POST['submit_login']))
?>